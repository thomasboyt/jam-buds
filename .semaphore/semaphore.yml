version: v1.0
name: Tests
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

promotions:
  - name: Deploy
    pipeline_file: deploy.yml

blocks:
  - name: "Install dependencies"
    task:
      prologue:
        commands:
          - checkout
          - sem-version node 12
      jobs:
      - name: "API: npm install"
        commands:
          - cd api
          - cache restore node-modules-api-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),node-modules-api-$SEMAPHORE_GIT_BRANCH,node-modules-api-master
          - npm install
          - cache store node-modules-api-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json) node_modules
      - name: "App: npm install"
        commands:
          - cd app
          - cache restore node-modules-app-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),node-modules-app-$SEMAPHORE_GIT_BRANCH,node-modules-app-master
          - npm install
          - cache store node-modules-app-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json) node_modules
      - name: "Spec: npm install"
        commands:
          - cd spec
          - cache restore node-modules-spec-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),node-modules-spec-$SEMAPHORE_GIT_BRANCH,node-modules-spec-master
          - npm install
          - cache store node-modules-spec-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json) node_modules

  - name: "Unit Tests"
    task:
      env_vars:
        - name: NODE_ENV
          value: "test"
        - name: DATABASE_URL
          value: "postgres://postgres@localhost:5432/jambuds_test"
        - name: REDIS_URL
          value: "redis://localhost:6379"
      prologue:
        commands:
          - checkout
          - sem-version node 12
          - cd api
          - cache restore node-modules-api-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),node-modules-api-$SEMAPHORE_GIT_BRANCH,node-modules-api-master
          - sem-service start postgres
          - sem-service start redis
      jobs:
      - name: Unit Tests
        commands:
          - npm test

  - name: "Integration Tests"
    task:
      secrets:
        - name: jambuds-integration-keys
      env_vars:
        - name: NODE_ENV
          value: "test"
        - name: DATABASE_URL
          value: "postgres://postgres@localhost:5432/jambuds_test"
        - name: REDIS_URL
          value: "redis://localhost:6379"
        - name: CI
          value: "1"
      prologue:
        commands:
          - checkout
          - sem-version node 12
          - cd api
          - cache restore node-modules-api-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),node-modules-api-$SEMAPHORE_GIT_BRANCH,node-modules-api-master
          - cd ../app
          - cache restore node-modules-app-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),node-modules-app-$SEMAPHORE_GIT_BRANCH,node-modules-app-master
          - cd ../spec
          - cache restore node-modules-spec-$SEMAPHORE_GIT_BRANCH-$(checksum package-lock.json),node-modules-spec-$SEMAPHORE_GIT_BRANCH,node-modules-spec-master
          - sem-service start postgres
          - createdb -U postgres -h 0.0.0.0 jambuds_test
          - sem-service start redis
      jobs:
      - name: Integration Tests
        commands:
          - cd ../app
          - npm run build
          - cd ../spec
          - npm test